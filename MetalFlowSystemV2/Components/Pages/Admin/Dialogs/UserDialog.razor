@using MetalFlowSystemV2.Data
@using MetalFlowSystemV2.Data.Entities
@using MetalFlowSystemV2.Data.Services.Admin
@using Microsoft.AspNetCore.Identity
@inject UserAdminService UserService
@inject BranchAdminService BranchService
@inject ISnackbar Snackbar

<MudDialog>
    <DialogContent>
        <MudForm @ref="form" @bind-IsValid="@success">
            <MudTextField T="string" Label="Full Name" @bind-Value="user.FullName" Required="true" RequiredError="Full Name is required!" />
            <MudTextField T="string" Label="Email" @bind-Value="user.Email" Required="true" RequiredError="Email is required!" InputType="InputType.Email" />

            @if (_isNew)
            {
                <MudTextField T="string" Label="Password" @bind-Value="password" Required="true" RequiredError="Password is required!" InputType="InputType.Password" />
            }

            <MudText Typo="Typo.subtitle1" Class="mt-4">Branch Assignments</MudText>
            <MudTable Items="@userBranches" Dense="true" Hover="true" Breakpoint="Breakpoint.None" Elevation="0">
                <HeaderContent>
                    <MudTh>Branch</MudTh>
                    <MudTh>Role</MudTh>
                    <MudTh>Default</MudTh>
                    <MudTh>Actions</MudTh>
                </HeaderContent>
                <RowTemplate>
                    <MudTd DataLabel="Branch">@context.BranchName</MudTd>
                    <MudTd DataLabel="Role">@context.RoleName</MudTd>
                    <MudTd DataLabel="Default">
                        <MudCheckBox T="bool" Value="@context.IsDefault" ValueChanged="@((val) => SetDefault(context, val))" Color="Color.Primary" Dense="true" />
                    </MudTd>
                    <MudTd DataLabel="Actions">
                         <MudIconButton Icon="@Icons.Material.Filled.Delete" Color="Color.Error" Size="Size.Small" OnClick="@(() => RemoveBranch(context))" />
                    </MudTd>
                </RowTemplate>
            </MudTable>

            <MudGrid Class="mt-2 align-center">
                <MudItem xs="5">
                    <MudSelect T="int" Label="Branch" @bind-Value="newBranchId" Strict="true" Dense="true" Margin="Margin.Dense">
                        @foreach (var branch in allBranches)
                        {
                            <MudSelectItem Value="@branch.Id">@branch.Name</MudSelectItem>
                        }
                    </MudSelect>
                </MudItem>
                <MudItem xs="5">
                     <MudSelect T="string" Label="Role" @bind-Value="newRoleId" Strict="true" Dense="true" Margin="Margin.Dense">
                        @foreach (var role in allRoles)
                        {
                            <MudSelectItem Value="@role.Id">@role.Name</MudSelectItem>
                        }
                    </MudSelect>
                </MudItem>
                <MudItem xs="2">
                    <MudButton Variant="Variant.Filled" Color="Color.Primary" Size="Size.Small" OnClick="AddBranch" Disabled="@(!CanAddBranch())">Add</MudButton>
                </MudItem>
            </MudGrid>
        </MudForm>
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="Cancel">Cancel</MudButton>
        <MudButton Color="Color.Primary" OnClick="Submit">@((_isNew ? "Create" : "Save"))</MudButton>
    </DialogActions>
</MudDialog>

@code {
    [CascadingParameter] IMudDialogInstance MudDialog { get; set; }

    [Parameter] public ApplicationUser user { get; set; } = new();

    private MudForm form;
    private bool success;
    private string password;
    private bool _isNew;

    // Branch Assignment State
    private List<UserBranchDto> userBranches = new();
    private List<Branch> allBranches = new();
    private List<IdentityRole> allRoles = new();

    private int newBranchId;
    private string newRoleId;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            if (string.IsNullOrEmpty(user.UserName) && string.IsNullOrEmpty(user.Email))
            {
                _isNew = true;
            }

            allBranches = await BranchService.GetAllAsync();
            allRoles = await UserService.GetAllRolesAsync();

            if (!_isNew)
            {
                // Load existing branches
                userBranches = await UserService.GetUserBranchDtosAsync(user.Id);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error loading data: {ex.Message}", Severity.Error);
        }
    }

    private bool CanAddBranch()
    {
        return newBranchId > 0 && !string.IsNullOrEmpty(newRoleId) && !userBranches.Any(ub => ub.BranchId == newBranchId);
    }

    private void AddBranch()
    {
        var branch = allBranches.FirstOrDefault(b => b.Id == newBranchId);
        var role = allRoles.FirstOrDefault(r => r.Id == newRoleId);

        if (branch != null && role != null)
        {
            userBranches.Add(new UserBranchDto
            {
                BranchId = branch.Id,
                BranchName = branch.Name,
                RoleId = role.Id,
                RoleName = role.Name
            });

            // Reset selection
            newBranchId = 0;
            newRoleId = "";
        }
    }

    private void RemoveBranch(UserBranchDto item)
    {
        userBranches.Remove(item);
    }

    private void SetDefault(UserBranchDto item, bool isDefault)
    {
        if (isDefault)
        {
            // Unset others
            foreach (var b in userBranches)
            {
                b.IsDefault = false;
            }
            item.IsDefault = true;
        }
        else
        {
            item.IsDefault = false;
        }
    }

    private async Task Submit()
    {
        await form.Validate();

        if (success)
        {
            // If editing, we pass the userBranches list back to be saved
            if (_isNew)
            {
                var result = await UserService.CreateUserAsync(user, password, userBranches);
                if (result.Result.Succeeded)
                {
                    MudDialog.Close(DialogResult.Ok(true));
                }
                else
                {
                    foreach(var error in result.Result.Errors)
                    {
                         Snackbar.Add(error.Description, Severity.Error);
                    }
                }
            }
            else
            {
                var result = await UserService.UpdateUserAsync(user, userBranches);
                if (result.Succeeded)
                {
                    MudDialog.Close(DialogResult.Ok(true));
                }
                else
                {
                     foreach(var error in result.Errors)
                    {
                         Snackbar.Add(error.Description, Severity.Error);
                    }
                }
            }
        }
    }

    private void Cancel() => MudDialog.Cancel();
}
