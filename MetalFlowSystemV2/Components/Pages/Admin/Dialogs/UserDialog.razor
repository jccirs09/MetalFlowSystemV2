@using Microsoft.AspNetCore.Identity
@using MetalFlowSystemV2.Data
@using MetalFlowSystemV2.Data.Entities
@using MetalFlowSystemV2.Data.Services.Admin
@inject UserAdminService UserService
@inject BranchAdminService BranchService
@inject ISnackbar Snackbar

<MudDialog>
    <DialogContent>
        <MudForm @ref="form" @bind-IsValid="@success">
            <MudTabs Elevation="2" Rounded="true" ApplyEffectsToContainer="true" PanelClass="pa-6">
                <MudTabPanel Text="User Details">
                    <MudTextField @bind-Value="_email" Label="Email" Required="true" RequiredError="Email is required" InputType="InputType.Email" ReadOnly="@(_isEditMode)" />
                    <MudTextField @bind-Value="_fullName" Label="Full Name" Required="true" RequiredError="Full Name is required" MaxLength="100" />

                    @if (!_isEditMode)
                    {
                        <MudTextField @bind-Value="_password" Label="Password" InputType="InputType.Password" Required="true" RequiredError="Password is required" />
                        <MudTextField @bind-Value="_confirmPassword" Label="Confirm Password" InputType="InputType.Password" Required="true" RequiredError="Confirm Password is required" Validation="@(new Func<string, string?>(PasswordMatch))" />
                    }
                </MudTabPanel>

                <MudTabPanel Text="Branch Access">
                    <MudGrid Class="mb-4">
                        <MudItem xs="5">
                            <MudSelect T="int?" Label="Branch" @bind-Value="_selectedBranchId" AnchorOrigin="Origin.BottomCenter">
                                @foreach (var branch in _allBranches)
                                {
                                    <MudSelectItem T="int?" Value="@branch.Id">@branch.Code - @branch.Name</MudSelectItem>
                                }
                            </MudSelect>
                        </MudItem>
                        <MudItem xs="5">
                            <MudSelect T="string" Label="Role" @bind-Value="_selectedRoleId" AnchorOrigin="Origin.BottomCenter">
                                @foreach (var role in _allRoles)
                                {
                                    <MudSelectItem Value="@role.Id">@role.Name</MudSelectItem>
                                }
                            </MudSelect>
                        </MudItem>
                        <MudItem xs="2" Class="d-flex align-center">
                            <MudIconButton Icon="@Icons.Material.Filled.Add" Color="Color.Primary" OnClick="AddBranchAssignment" />
                        </MudItem>
                    </MudGrid>

                    <MudTable Items="_branchAssignments" Dense="true" Hover="true" Striped="true">
                        <HeaderContent>
                            <MudTh>Branch</MudTh>
                            <MudTh>Role</MudTh>
                            <MudTh>Default</MudTh>
                            <MudTh>Action</MudTh>
                        </HeaderContent>
                        <RowTemplate>
                            <MudTd>@context.BranchName</MudTd>
                            <MudTd>@context.RoleName</MudTd>
                            <MudTd>
                                @* Use a checkbox that acts like a radio button by unchecking others *@
                                <MudCheckBox T="bool" Value="@context.IsDefault" ValueChanged="@((val) => OnDefaultChanged(context, val))" Color="Color.Primary" Dense="true" />
                            </MudTd>
                            <MudTd>
                                <MudIconButton Icon="@Icons.Material.Filled.Delete" Color="Color.Error" Size="Size.Small" OnClick="@(() => RemoveBranchAssignment(context))" />
                            </MudTd>
                        </RowTemplate>
                    </MudTable>
                </MudTabPanel>
            </MudTabs>
        </MudForm>
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="Cancel">Cancel</MudButton>
        <MudButton Color="Color.Primary" OnClick="Submit">Save</MudButton>
    </DialogActions>
</MudDialog>

@code {
    [CascadingParameter] IMudDialogInstance MudDialog { get; set; } = default!;

    [Parameter] public ApplicationUser? User { get; set; }

    private MudForm form = default!;
    private bool success;
    private bool _isEditMode;

    // Fields
    private string _email = string.Empty;
    private string _fullName = string.Empty;
    private string _password = string.Empty;
    private string _confirmPassword = string.Empty;

    // Data
    private List<Branch> _allBranches = new();
    private List<IdentityRole> _allRoles = new();
    private List<UserBranchDto> _branchAssignments = new();

    // Selection
    private int? _selectedBranchId;
    private string _selectedRoleId = string.Empty;

    protected override async Task OnInitializedAsync()
    {
        _allBranches = await BranchService.GetAllAsync();
        _allRoles = await UserService.GetAllRolesAsync();

        if (User != null)
        {
            _isEditMode = true;
            _email = User.Email ?? "";
            _fullName = User.FullName ?? "";

            // Load assigned branches
            _branchAssignments = await UserService.GetUserBranchDtosAsync(User.Id);
        }
    }

    private string? PasswordMatch(string arg)
    {
        if (_password != arg)
            return "Passwords do not match";
        return null;
    }

    private void OnDefaultChanged(UserBranchDto dto, bool isChecked)
    {
        if (isChecked)
        {
            // Uncheck all others
            foreach (var item in _branchAssignments)
            {
                item.IsDefault = false;
            }
            // Check this one
            dto.IsDefault = true;
        }
        else
        {
            // Allowing unchecking (no default) is fine.
            dto.IsDefault = false;
        }
    }

    private void AddBranchAssignment()
    {
        if (_selectedBranchId == null || _selectedBranchId == 0 || string.IsNullOrEmpty(_selectedRoleId))
        {
            Snackbar.Add("Please select both Branch and Role", Severity.Warning);
            return;
        }

        // Check if branch already assigned
        var existing = _branchAssignments.FirstOrDefault(b => b.BranchId == _selectedBranchId.Value);
        if (existing != null)
        {
             // Update role
             existing.RoleId = _selectedRoleId;
             var roleName = _allRoles.FirstOrDefault(r => r.Id == _selectedRoleId)?.Name ?? "Unknown";
             existing.RoleName = roleName;
             Snackbar.Add("Updated role for existing branch assignment", Severity.Info);
        }
        else
        {
            var branch = _allBranches.FirstOrDefault(b => b.Id == _selectedBranchId.Value);
            var role = _allRoles.FirstOrDefault(r => r.Id == _selectedRoleId);

            if (branch != null && role != null)
            {
                var newDto = new UserBranchDto
                {
                    BranchId = branch.Id,
                    BranchName = branch.Name,
                    RoleId = role.Id,
                    RoleName = role.Name ?? "Unknown",
                    IsDefault = false
                };

                // If it's the first one, maybe make it default?
                if (!_branchAssignments.Any())
                {
                    newDto.IsDefault = true;
                }

                _branchAssignments.Add(newDto);
            }
        }
    }

    private void RemoveBranchAssignment(UserBranchDto dto)
    {
        _branchAssignments.Remove(dto);
    }

    private async Task Submit()
    {
        await form.Validate();

        if (success)
        {
            try
            {
                if (_isEditMode && User != null)
                {
                    var userToUpdate = new ApplicationUser
                    {
                        Id = User.Id,
                        Email = _email,
                        FullName = _fullName
                    };

                    var result = await UserService.UpdateUserAsync(userToUpdate, _branchAssignments);
                    if (result.Succeeded)
                    {
                        Snackbar.Add("User updated successfully", Severity.Success);
                        MudDialog.Close(DialogResult.Ok(true));
                    }
                    else
                    {
                        foreach (var error in result.Errors)
                            Snackbar.Add(error.Description, Severity.Error);
                    }
                }
                else
                {
                    var newUser = new ApplicationUser
                    {
                        UserName = _email,
                        Email = _email,
                        FullName = _fullName,
                        EmailConfirmed = true // Auto confirm for admin created users
                    };

                    var (result, createdUser) = await UserService.CreateUserAsync(newUser, _password, _branchAssignments);
                    if (result.Succeeded)
                    {
                        Snackbar.Add("User created successfully", Severity.Success);
                        MudDialog.Close(DialogResult.Ok(true));
                    }
                    else
                    {
                         foreach (var error in result.Errors)
                            Snackbar.Add(error.Description, Severity.Error);
                    }
                }
            }
            catch (Exception ex)
            {
                Snackbar.Add($"Error: {ex.Message}", Severity.Error);
            }
        }
    }

    private void Cancel() => MudDialog.Cancel();
}
