@using MetalFlowSystemV2.Data.Entities
@using MetalFlowSystemV2.Data.Services.Admin
@inject ItemService ItemService
@inject ISnackbar Snackbar

<MudDialog>
    <DialogContent>
        <MudForm @ref="form" @bind-IsValid="@success">
            <MudTextField @bind-Value="Item.ItemCode" Label="Item Code" Required="true" ReadOnly="@(_isEdit)" />
            <MudTextField @bind-Value="Item.Description" Label="Description" Required="true" Lines="2" />

            <MudSelect T="string" Label="UOM" Value="@Item.UOM" ValueChanged="OnUOMChanged" AnchorOrigin="Origin.BottomCenter">
                <MudSelectItem Value="@("PCS")">PCS (Sheet)</MudSelectItem>
                <MudSelectItem Value="@("LBS")">LBS (Coil)</MudSelectItem>
            </MudSelect>

            @if (Item.UOM == "PCS")
            {
                 <MudNumericField @bind-Value="Item.PoundsPerSquareFoot" Label="Pounds Per Sq Ft" Required="true" Min="0.0001M" Format="N4" />

                 <MudSelect T="int?" Label="Parent Coil" @bind-Value="Item.ParentItemId" AnchorOrigin="Origin.BottomCenter" Clearable="true">
                    @foreach (var coil in _coils)
                    {
                        <MudSelectItem T="int?" Value="@coil.Id">@coil.ItemCode - @coil.Description</MudSelectItem>
                    }
                </MudSelect>
            }

            <MudCheckBox @bind-Value="Item.IsActive" Label="Active" />
        </MudForm>
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="Cancel">Cancel</MudButton>
        <MudButton Color="Color.Primary" OnClick="Submit">Save</MudButton>
    </DialogActions>
</MudDialog>

@code {
    [CascadingParameter] IMudDialogInstance MudDialog { get; set; } = default!;

    [Parameter] public Item Item { get; set; } = new();

    private MudForm form = default!;
    private bool success;
    private bool _isEdit;
    private List<Item> _coils = new();

    protected override async Task OnInitializedAsync()
    {
        if (Item.Id != 0)
        {
            _isEdit = true;
        }
        else
        {
            // Default new item
            if (string.IsNullOrEmpty(Item.UOM))
            {
                 Item.UOM = "PCS";
                 Item.Type = ItemType.Sheet;
            }
        }

        _coils = await ItemService.GetCoilItemsAsync();
    }

    private void OnUOMChanged(string uom)
    {
        Item.UOM = uom;
        if (uom == "PCS")
        {
            Item.Type = ItemType.Sheet;
        }
        else if (uom == "LBS")
        {
            Item.Type = ItemType.Coil;
            Item.PoundsPerSquareFoot = null;
            Item.ParentItemId = null;
        }
    }

    private async Task Submit()
    {
        await form.Validate();

        if (success)
        {
            try
            {
                if (Item.Type != ItemType.Sheet)
                {
                    Item.ParentItemId = null; // Clear parent if not Sheet
                }

                if (_isEdit)
                {
                    await ItemService.UpdateAsync(Item);
                    Snackbar.Add("Item updated", Severity.Success);
                }
                else
                {
                    await ItemService.CreateAsync(Item);
                    Snackbar.Add("Item created", Severity.Success);
                }
                MudDialog.Close(DialogResult.Ok(true));
            }
            catch (Exception ex)
            {
                Snackbar.Add($"Error: {ex.Message}", Severity.Error);
            }
        }
    }

    private void Cancel() => MudDialog.Cancel();
}
