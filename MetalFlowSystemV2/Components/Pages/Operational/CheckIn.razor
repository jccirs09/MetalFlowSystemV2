@page "/check-in"
@layout EmptyLayout
@rendermode @(new InteractiveServerRenderMode(prerender: false))
@attribute [Authorize]
@using MetalFlowSystemV2.Data.Entities
@using MetalFlowSystemV2.Data.Services
@using MetalFlowSystemV2.Data.Services.Admin
@inject ShiftInstanceService ShiftService
@inject BranchAdminService BranchService
@inject UserWorkAssignmentService AssignmentService
@inject IDialogService DialogService
@inject ISnackbar Snackbar
@inject NavigationManager NavManager
@inject AuthenticationStateProvider AuthStateProvider

<MudContainer MaxWidth="MaxWidth.Small" Class="mt-16">
    <MudCard Elevation="4">
        <MudCardHeader>
            <CardHeaderContent>
                <MudText Typo="Typo.h5" Align="Align.Center">Daily Check-In</MudText>
            </CardHeaderContent>
        </MudCardHeader>
        <MudCardContent>
            @if (_loading)
            {
                <MudProgressCircular Color="Color.Primary" Indeterminate="true" Class="d-block mx-auto" />
            }
            else if (_assignment == null)
            {
                <MudAlert Severity="Severity.Warning" Class="mb-4">
                    No active work assignment found. Please contact your administrator.
                </MudAlert>
                @if (_branches.Count > 1)
                {
                    <MudSelect T="int?" Label="Select Branch" @bind-Value="_selectedBranchId" Class="mb-4">
                        @foreach (var b in _branches)
                        {
                            <MudSelectItem Value="@((int?)b.Id)">@b.Name</MudSelectItem>
                        }
                    </MudSelect>
                    <MudButton Variant="Variant.Filled" Color="Color.Primary" FullWidth="true" OnClick="CheckAssignment">Retry</MudButton>
                }
            }
            else
            {
                <MudText Typo="Typo.h6" Align="Align.Center" Class="mb-2">Confirm Your Shift</MudText>
                <MudDivider Class="mb-4" />

                <MudText><b>Branch:</b> @_assignment.Branch?.Name</MudText>
                <MudText><b>Shift:</b> @_assignment.ShiftTemplate?.Name</MudText>
                @if (_assignment.WorkMode == WorkMode.ProductionArea)
                {
                     <MudText><b>Area:</b> @_assignment.ProductionArea?.Name (@_assignment.ProductionArea?.Code)</MudText>
                }
                else
                {
                     <MudText><b>Station:</b> @_assignment.PackingStation?.Name (@_assignment.PackingStation?.Code)</MudText>
                }
                <MudText><b>Date:</b> @_today.ToString("yyyy-MM-dd")</MudText>

                <MudButton Variant="Variant.Filled" Color="Color.Success" Size="Size.Large" FullWidth="true" Class="mt-6" OnClick="ConfirmCheckIn">
                    CONFIRM CHECK-IN
                </MudButton>
            }
        </MudCardContent>
    </MudCard>
</MudContainer>

@code {
    private bool _loading = true;
    private UserWorkAssignment? _assignment;
    private List<Branch> _branches = new();
    private int? _selectedBranchId;
    private string _userId = "";
    private DateOnly _today = DateOnly.FromDateTime(DateTime.Now);

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;
        if (user.Identity?.IsAuthenticated == true)
        {
             _userId = user.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value ?? "";
        }

        // Try to guess branch or load list
        _branches = await BranchService.GetAllAsync();

        // If single branch system or user usually works at one, we might default.
        // For Phase 2, let's ask user to select branch if we can't find one, OR iterate branches to find assignment?
        // Better: User selects branch context globally usually.
        // Let's see if we can find ANY active assignment for this user across branches?
        // Service `GetActiveAssignmentAsync` requires branchId.
        // Let's default to first branch or let user pick.

        if (_branches.Count == 1)
        {
            _selectedBranchId = _branches[0].Id;
            await CheckAssignment();
        }
        else
        {
            _loading = false;
        }
    }

    private async Task CheckAssignment()
    {
        if (_selectedBranchId == null || string.IsNullOrEmpty(_userId)) return;

        _loading = true;
        try
        {
            _assignment = await AssignmentService.GetActiveAssignmentAsync(_userId, _selectedBranchId.Value);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error checking assignment: {ex.Message}", Severity.Error);
        }
        finally
        {
            _loading = false;
        }
    }

    private async Task ConfirmCheckIn()
    {
        if (_assignment == null) return;

        _loading = true;
        try
        {
            await ShiftService.CheckInAsync(_userId, _assignment.BranchId, _today);
            Snackbar.Add("Checked In Successfully!", Severity.Success);
            // Redirect to home or dashboard (Phase 3)
            NavManager.NavigateTo("/");
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Check-In Failed: {ex.Message}", Severity.Error);
        }
        finally
        {
            _loading = false;
        }
    }
}
